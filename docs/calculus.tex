\documentclass{docs}

\title{A forward focused calculus for Zsyntax}
\author{Filippo Sestini}

\begin{document}

\maketitle
\tableofcontents

\section{Introduction}

\section{Backward sequent calculus}

\subsection{Control sets}

\subsubsection{Annotation}

\begin{definition}
  An annotated sequent is syntactically represented as $\Gamma; \Delta
  \Longrightarrow_{\ctrlset{}} C$, where $\Gamma, \Delta$ are the ordinary
  unrestricted and linear contexts, $C$ is the succedent formula and
  $\ctrlset{}$ is a control set.
\end{definition}

\begin{figure}[ht]
  \begin{mdframed}
    \[
      \begin{prooftree}
        \justifies
        \Gamma; P \Longrightarrow_{\emptyset} P
        \using{init}
      \end{prooftree}
      \qquad \qquad
      \begin{prooftree}
        \Gamma, A; \Delta, A \Longrightarrow_{\ctrlset{}} C
        \justifies
        \Gamma, A; \Delta \Longrightarrow_{\ctrlset{}} C
        \using{copy}
      \end{prooftree}
    \]

    \[
      \begin{prooftree}
        \Gamma; \Delta \Longrightarrow_{\ctrlset{1}} A
        \qquad
        \Gamma; \Delta' \Longrightarrow_{\ctrlset{2}} B
        \justifies
        \Gamma; \Delta, \Delta' \Longrightarrow_{\ctrlset{1}\cup \ctrlset{2}} A \otimes B
        \using{\otimes R}
      \end{prooftree}
      \qquad \qquad
      \begin{prooftree}
        \Gamma; \Delta, A, B \Longrightarrow_{\ctrlset{}} C
        \justifies
        \Gamma; \Delta, A \otimes B \Longrightarrow_{\ctrlset{}} C
        \using{\otimes L}
      \end{prooftree}
    \]

    \[
      \begin{prooftree}
        \Gamma; \Delta_1 \Longrightarrow_{\ctrlset{1}} A
        \qquad
        \Gamma; \Delta_2, B \Longrightarrow_{\ctrlset{2}} C
        \justifies
        \Gamma; \Delta_1, \Delta_2, A \limp B
        \Longrightarrow_{\ctrlset{1} \cup \ctrlset{2} \cup \ctrlset{A \rightarrow B}} C
      \end{prooftree}
      \qquad \qquad
      \begin{prooftree}
        \Gamma; \Delta, A \Longrightarrow_{\ctrlset{}} B
        \justifies
        \Gamma; \Delta \Longrightarrow_{\ctrlset{}} A \limp B
        \using{\limp R}
      \end{prooftree}
    \]
  \end{mdframed}
  \caption{\label{myfig} Annotated backward sequent calculus.}
\end{figure}



\subsubsection{Checking}

Consider the usual example of .... More precisely, we have
an axiom $E\otimes S \rightarrow E \odot S$,
with $\ctrlset{E\otimes S \rightarrow E \odot S} = \{I\}$, thus we expect
$E \otimes S\otimes I \limp E \odot S \otimes I$ to \emph{not} be valid in our
checked, annotated sequent calculus. The following is the annotated derivation,
where $\Gamma \equiv E\otimes S \rightarrow E \odot S$:

\[
  \begin{prooftree}
    \[
      \[
        \[ \justifies \Gamma; I \Longrightarrow_{\emptyset} I \using{\init} \]
        \qquad
        \[
          \[
            \[
              \[
                \justifies
                \Gamma; E \Longrightarrow_{\emptyset} E
                \using{\init}
              \]\qquad
              \[
                \justifies
                \Gamma; S \Longrightarrow_{\emptyset} S
                \using{\init}
              \]
              \justifies
              \Gamma; E , S \Longrightarrow_{\emptyset} E \otimes S
              \using{\otimes R}
            \]
            \qquad
            \[
              \justifies \Gamma; E\odot S \Longrightarrow_{\emptyset} E \odot S
              \using{\init}
            \]
            \justifies
            \Gamma; E\otimes S \limp E\odot S, E , S \Longrightarrow_{\{I\}} E \odot S
            \using{\limp L}
          \]
          \justifies
          \Gamma; E , S \Longrightarrow_{\{I\}} E \odot S
          \using{\copyrule}
        \]
        \justifies
        \Gamma; E , S , I \Longrightarrow_{\{I\}} E \odot S \otimes I
        \using{\otimes R}
      \]
      \justifies
      \Gamma; E \otimes S \otimes I \Longrightarrow_{\{I\}}  E \odot S \otimes I
      \using{\otimes L \times 3}
    \]
    \justifies
    \Gamma; \cdot \Longrightarrow_{\{I\}} E \otimes S \otimes I \limp E \odot S \otimes
   I
   \using{\limp R}
  \end{prooftree}
\]

Therefore, if we ignore the constraints of the control sets, the formula is
actually derivable (since it is a theorem in Linear Logic). A first attempt to
block this may be to impose a side condition to the applicability of the rule
$\otimes R$, restricting it to conclusion sequents in which the context respects
the control sets of both premises:


\[
  \begin{prooftree}
    \Gamma; \Delta_1 \Longrightarrow_{\ctrlset{1}} A
    \qquad
    \Gamma; \Delta_2 \Longrightarrow_{\ctrlset{2}} B
    \justifies
    \Gamma; \Delta_1, \Delta_2 \Longrightarrow_{\ctrlset{1} \cup \ctrlset{2}} A
    \otimes B
  \end{prooftree}
  \quad
  \respects{(\Gamma, \Delta_1, \Delta_2)}{(\ctrlset{1} \cup \ctrlset{2})}
\]

a similar addition can be done to $\limp L$, for the same reason:

\[
  \begin{prooftree}
    \Gamma; \Delta_1 \Longrightarrow_{\ctrlset{1}} A
    \qquad
    \Gamma; \Delta_2, B \Longrightarrow_{\ctrlset{2}} C
    \justifies
    \Gamma; \Delta_1, \Delta_2, A \limp B
    \Longrightarrow_{\ctrlset{1} \cup \ctrlset{2} \cup \ctrlset{A \rightarrow B}} C
  \end{prooftree}
  \quad
  \respects{(\Gamma, \Delta_1, \Delta_2)}{(\ctrlset{1} \cup \ctrlset{2})}
\]

It is immediate to notice that, with these new side conditions, the formula
above is no longer derivable. This modification, however, turns out to be too
restrictive. Suppose we have $\ctrlset{A \rightarrow B} = \{I\}$. The following
is valid in Zsyntax:

\[
  I \rightarrow A, A \rightarrow B, I, A \models A \otimes B
\]

since we have the following derivation:

\[
  \begin{prooftree}
    \[
      \[
        I \rightarrow A, A \rightarrow B, I, A
        \justifies
        A, A, A \rightarrow B
        \using{\rightarrow \mathcal{E}}
      \]
      \justifies
      A, B
      \using{\rightarrow \mathcal{E}}
    \]
    \justifies
    A \otimes B
    \using{\otimes \mathcal{I}}
  \end{prooftree}
\]

Notice that here we are indeed allowed to eliminate $A \rightarrow B$, because
the inhibitor $I$ which may have blocked the reaction has already been
eliminated in a previous stage of the deduction/reaction. An easy check can
verify that, with the side conditions above, the sequent
$\Gamma; \cdot \Longrightarrow I \otimes A \limp A \otimes B$, where $\Gamma$
contains the axioms as usual, cannot be derived.

The reason is that the side conditions, formulated as above, cannot capture the
temporal differences in the reactions. In this example, the reaction starts with
$I$, which is indeed an inhibitor for $A \rightarrow B$, but since the reaction
between $A \rightarrow B$ and $A$ happens at a later stage, when $I$ has
disappeared from the \emph{current state}, its presence in the control set of $A
\rightarrow B$ causes no problem.

In order to generalize this, consider the premises of $\limp L$, that is,
$\Gamma; \Delta_1 \Longrightarrow_{\ctrlset{1}} A$ and
$\Gamma; \Delta_2, B \Longrightarrow_{\ctrlset{2}} C$. These may be interpreted
as having two deductions

\[
  \begin{prooftree}
    A_1, \dots A_n, \Delta_1
    \leadsto
    A
  \end{prooftree}
  \qquad
  \begin{prooftree}
    A_{n+1}, \dots A_{n+m}, \Delta_2, B
    \leadsto
    C
  \end{prooftree}
\]

where $\forall i \in \{1,\dots,n+m\}, A_i \in \Gamma$, and that result from
rules that can be applied under a control set respectively $\ctrlset{1}$ and
$\ctrlset{2}$.  Suppose now that we start from a Z-state
$A_1, \dots A_n, \Delta_1, A_{n+1}, \dots A_{n+m}, \Delta_2, A\rightarrow B$. It
is understood that we can reproduce the first deduction to get

\[
  \begin{prooftree}
    A_1, \dots A_n, \Delta_1, A_{n+1}, \dots A_{n+m}, \Delta_2, A \rightarrow B
    \leadsto
    A, A_{n+1}, \dots A_{n+m}, \Delta_2, B, A \rightarrow B
  \end{prooftree}
\]

as long as all formulas in $A_{n+1}, \dots A_{n+m}, \Delta_2, A \rightarrow B$
respect the constraints imposed by the control set $\ctrlset{1}$. Then, as long
as $A_{n+1}, \dots A_{n+m}, \Delta_2$ respect $\ctrlset{A\rightarrow B}$, we
can eliminate the implication

\[
  \begin{prooftree}
    \[
      A_1, \dots A_n, \Delta_1, A_{n+1}, \dots A_{n+m}, \Delta_2, A \rightarrow B
      \leadsto
      A, A_{n+1}, \dots A_{n+m}, \Delta_2, A \rightarrow B
    \]
    \justifies
    A_{n+1}, \dots A_{n+m}, \Delta_2, B
    \using{\rightarrow \mathcal{E}}
  \end{prooftree}
\]

now we can just reproduce the second derivation, to get


\[
  \begin{prooftree}
    \[
      \[
        A_1, \dots A_n, \Delta_1, A_{n+1}, \dots A_{n+m}, \Delta_2, A \rightarrow B
        \leadsto
        A, A_{n+1}, \dots A_{n+m}, \Delta_2, A \rightarrow B
      \]
      \justifies
      A_{n+1}, \dots A_{n+m}, \Delta_2, B
      \using{\rightarrow \mathcal{E}}
    \]
    \leadsto
    C
  \end{prooftree}
\]

We can relax the side conditions to allow for these kinds of deduction in the
sequent calculus, as follows:

\[
  \begin{prooftree}
    \Gamma; \Delta_1 \Longrightarrow_{\ctrlset{1}} A
    \qquad
    \Gamma; \Delta_2, B \Longrightarrow_{\ctrlset{2}} C
    \justifies
    \Gamma; \Delta_1, \Delta_2, A \limp B
    \Longrightarrow_{\ctrlset{1} \cup \ctrlset{2} \cup \ctrlset{A \rightarrow B}} C
  \end{prooftree}
  \quad \text{provided} \quad
  \begin{cases}
    \respects{(\Gamma, \Delta_2, A \rightarrow B)}{\ctrlset{1}} \\
    \respects{(\Gamma, \Delta_2)}{\ctrlset{A \rightarrow B}}
  \end{cases}
\]

A similar situation arises with the tensor product. Consider the premises of the
rule $\otimes R$, i.e.,
$\Gamma; \Delta_1 \Longrightarrow_{\ctrlset{1}} A$ and
$\Gamma; \Delta_2 \Longrightarrow_{\ctrlset{2}} B$. This means that we have

\[
  \begin{prooftree}
    A_1, \dots A_n, \Delta_1
    \leadsto
    A
  \end{prooftree}
  \qquad
  \begin{prooftree}
    A_{n+1}, \dots A_{n+m}, \Delta_2
    \leadsto
    B
  \end{prooftree}
\]

where $\forall i \in \{1,\dots,n+m\}, A_i \in \Gamma$, and that result from
rules that can be applied under a control set respectively $\ctrlset{1}$ and
$\ctrlset{2}$.  Suppose now that we start from a Z-state
$A_1, \dots A_n, \Delta_1, A_{n+1}, \dots A_{n+m}, \Delta_2$.  Then, if we view
the two deductions above as monolithic, we have essentially three different
ways to derive $A \otimes B$.

\begin{enumerate}
\item We may start by reproducing the first derivation, followed by the second:

  \[
    \begin{prooftree}
      \[
        \[
          A_1, \dots A_n, \Delta_1, A_{n+1}, \dots A_{n+m}, \Delta_2
          \leadsto
          A, A_{n+1}, \dots A_{n+m}, \Delta_2
        \]
        \leadsto
        A, B
      \]
      \justifies
      A \otimes B
    \end{prooftree}
  \]

  provided $A_{n+1}, \dots A_{n+m}, \Delta_2$ respects $\ctrlset{1}$ and
  $A$ respects $\ctrlset{2}$.

\item We may start by reproducing the second derivation, followed by the first:

  \[
    \begin{prooftree}
      \[
        \[
          A_1, \dots A_n, \Delta_1, A_{n+1}, \dots A_{n+m}, \Delta_2
          \leadsto
          A_1, \dots A_n, \Delta_1, B
        \]
        \leadsto
        A, B
      \]
      \justifies
      A \otimes B
    \end{prooftree}
  \]

  provided $A_1, \dots A_n, \Delta_1$ respects $\ctrlset{2}$ and
  $B$ respects $\ctrlset{1}$.

\item We may reproduce the two derivations in parallel, as allowed by Zsyntax:

  \[
    \begin{prooftree}
      \[
        A_1, \dots A_n, \Delta_1, A_{n+1}, \dots A_{n+m}, \Delta_2
        \leadsto
        A, B
      \]
      \justifies
      A \otimes B
    \end{prooftree}
  \]

  provided both $\Delta_1$ and $\Delta_2$ respect $\ctrlset{1} \cup \ctrlset{2}$.
\end{enumerate}

We can relax the side conditions to allow for these kinds of deduction in the
sequent calculus, as follows:

\[
  \begin{prooftree}
    \Gamma; \Delta_1 \Longrightarrow_{\ctrlset{1}} A
    \qquad
    \Gamma; \Delta_2 \Longrightarrow_{\ctrlset{2}} B
    \justifies
    \Gamma; \Delta_1, \Delta_2 \Longrightarrow_{\ctrlset{1} \cup \ctrlset{2}} A
    \otimes B
  \end{prooftree}\quad \text{provided} \quad
  \begin{cases}
    ((\Gamma, \Delta_2) || \ctrlset{1} \wedge (\Gamma, A) || \ctrlset{2}) \; \vee \\
    ((\Gamma, \Delta_1) || \ctrlset{2} \wedge (\Gamma, B) || \ctrlset{1}) \; \vee \\
    ((\Gamma, \Delta_1, \Delta_2) || \ctrlset{1} \cup \ctrlset{2})
  \end{cases}
\]

Notice that, with these modifications, it does not hold that if
$\Gamma; \Delta \Longrightarrow_{\ctrlset{}} C$ then
$\respects{(\Gamma, \Delta)}{\ctrlset{}}$.  Nevertheless, this has no influence
on the fact that we must do the union of the control sets of the premises in the
conclusion sequent. In fact, the control set annotation in a sequent tells us
what must be true externally, i.e., in a hypothetical additional context in
which we may want to make the reaction happen, whereas the check condition tells
us what must hold internally, i.e. in the starting context/state
$\Gamma, \Delta$ itself, in order for the sequent to represent a biologically
correct reaction. It follows that it makes sense for the check conditions to be
less restrictive that the ones we may think of (and that we described as our
first attempt), since they may take into account the order in which internal
reactions, represented by the premise sequents, take place. Instead, the control
set that annotates the conclusion sequent must account for all these conditions
regardless of the order in which they occur
internally. Figure~\ref{annotated-checked} shows the complete calculus with the
updated side conditions.

\begin{figure}[h]
  \begin{mdframed}
    \[
      \begin{prooftree}
        \justifies
        \Gamma; P \Longrightarrow^c_{\emptyset} P
        \using{\init}
      \end{prooftree}
      \qquad \qquad
      \begin{prooftree}
        \Gamma, A; \Delta, A \Longrightarrow^c_{\ctrlset{}} C
        \justifies
        \Gamma, A; \Delta \Longrightarrow^c_{\ctrlset{}} C
        \using{\copyrule}
      \end{prooftree}
    \]

    \[
      \begin{prooftree}
        \Gamma; \Delta, A, B \Longrightarrow^c_{\ctrlset{}} C
        \justifies
        \Gamma; \Delta, A \otimes B \Longrightarrow^c_{\ctrlset{}} C
        \using{\otimes L}
      \end{prooftree}
      \qquad \qquad
      \begin{prooftree}
        \Gamma; \Delta, A \Longrightarrow^c_{\ctrlset{}} B
        \justifies
        \Gamma; \Delta \Longrightarrow^c_{\ctrlset{}} A \limp B
        \using{\limp R}
      \end{prooftree}
    \]

    \[
      \begin{prooftree}
        \Gamma; \Delta_1 \Longrightarrow_{\ctrlset{1}} A
        \qquad
        \Gamma; \Delta_2 \Longrightarrow_{\ctrlset{2}} B
        \justifies
        \Gamma; \Delta_1, \Delta_2 \Longrightarrow_{\ctrlset{1} \cup \ctrlset{2}} A
        \otimes B
        \using{\otimes R}
      \end{prooftree}\quad
      \begin{cases}
        ((\Gamma, \Delta_2) || \ctrlset{1} \wedge (\Gamma, A) || \ctrlset{2}) \; \vee \\
        ((\Gamma, \Delta_1) || \ctrlset{2} \wedge (\Gamma, B) || \ctrlset{1}) \; \vee \\
        ((\Gamma, \Delta_1, \Delta_2) || \ctrlset{1} \cup \ctrlset{2})
      \end{cases}
    \]

    \[
      \begin{prooftree}
        \Gamma; \Delta_1 \Longrightarrow_{\ctrlset{1}} A
        \qquad
        \Gamma; \Delta_2, B \Longrightarrow_{\ctrlset{2}} C
        \justifies
        \Gamma; \Delta_1, \Delta_2, A \limp B
        \Longrightarrow_{\ctrlset{1} \cup \ctrlset{2} \cup \ctrlset{A
            \rightarrow B}} C
        \using{\limp L}
      \end{prooftree}
      \quad
      \begin{cases}
        \respects{(\Gamma, \Delta_2, A \rightarrow B)}{\ctrlset{1}} \\
        \respects{(\Gamma, \Delta_2)}{\ctrlset{A \rightarrow B}}
      \end{cases}
    \]

  \end{mdframed}
  \caption{\label{annotated-checked} Annotated checked backward sequent calculus.}
\end{figure}

\begin{definition}
  We augment the notation $\Gamma \vdash \Delta$ w.r.t. theorems of Zsyntax with
  the notation $\Gamma \vdash_{\ctrlset{}} \Delta$ for a control set
  $\ctrlset{}$, to mean that it is possible to derive

  \[
    \begin{prooftree}
      \nabla, \Gamma
      \leadsto
      \nabla, \Delta
    \end{prooftree}
  \]

  for every $\nabla$ such that $\respects{\nabla}{\ctrlset{}}$.
\end{definition}

\begin{theorem}[Soundness]
  If $\Gamma; \Delta \Longrightarrow^c_{\ctrlset{}} C$, then
  $A_1, \dots, A_n, \Delta \vdash_{\ctrlset{}} C$ where $A_i \in \Gamma$ for
  all $i \in \{ 1, \dots, n\}$.
\end{theorem}
\begin{proof}
  By induction on the height of the derivation.

  \begin{enumerate}
  \item The last rule is $\init$. Then, the sequent is $\Gamma; P
    \Longrightarrow_{\emptyset} P$, and $P \models_{\emptyset} P$ by reflexivity
    of the $\models$ relation.

  \item The last rule is $\copyrule$. Then, by inductive hypothesis, there is a
    derivation $\mathcal{D}$ such that

    \[
      \begin{prooftree}
        A_1, \dots, A_n, \Delta, A
        \leadsto
        C
      \end{prooftree}
    \]

    where $A \in \Gamma$ and $A_i \in \Gamma$ for all $i \in \{ 1, \dots, n\}$.
    But then $\mathcal{D}$ satisfies the thesis.

  \item The last rule is $\otimes L$. Then, by inductive hypothesis, we have a
    derivation

    \[
      \begin{prooftree}
        A_1, \dots, A_n, \Delta, A, B
        \leadsto
        C
      \end{prooftree}
    \]

    where $A_i \in \Gamma$ for all $i \in \{ 1, \dots, n\}$.
    Then, by $\otimes \mathcal{E}$, we get

    \[
      \begin{prooftree}
        \[
          A_1, \dots, A_n, \Delta, A \otimes B
          \justifies
          A_1, \dots, A_n, \Delta, A, B
          \using{\otimes \mathcal{E}}
        \]
        \leadsto
        C
      \end{prooftree}
    \]

    since $\otimes \mathcal{E}$ does not introduce any additional constraints,
    we can conclude the thesis, i.e., $A_1, \dots, A_n, \Delta, A \otimes B
    \models_{\ctrlset{}} C$.

  \item The last rule is $\limp R$. Then, by inductive hypothesis, we have a
    derivation

    \[
      \begin{prooftree}
        A_1, \dots, A_n, \Delta, A
        \leadsto
        B
      \end{prooftree}
    \]

    where $A_i \in \Gamma$ for all $i \in \{ 1, \dots, n\}$.
    Then, by $\rightarrow \mathcal{I}$, we may deduce $A \rightarrow B$ from
    $A_1, \dots, A_n, \Delta$, without adding additional constraints to those of
    the above derivation. Hence, $A_1, \dots, A_n, \Delta \models_{\ctrlset{}} A
    \rightarrow B$.

  \item The last rule is $\otimes R$. Then, by inductive hypothesis


    \[
      \begin{prooftree}
        A_1, \dots, A_n, \Delta_1
        \leadsto
        A
      \end{prooftree}
      \qquad \qquad
      \begin{prooftree}
        A_{n+1}, \dots, A_{n+m}, \Delta_2
        \leadsto
        B
      \end{prooftree}
    \]

    where $A_i \in \Gamma$ for all $i \in \{ 1, \dots, n+m\}$.
    We now distinguish the three cases in which the check condition can be
    satisfied:

    \begin{enumerate}
    \item Case
      $\respects{\Gamma, \Delta_2}{\ctrlset{1}} \wedge \respects{\Gamma,
        A}{\ctrlset{2}}$. Then, we can derive

      \[
        \begin{prooftree}
          \[
            \[
              A_1, \dots, A_n, \Delta_1, A_{n+1}, \dots, A_{n+m}, \Delta_2
              \leadsto
              A, A_{n+1}, \dots, A_{n+m}, \Delta_2
            \]
            \leadsto
            A, B
          \]
          \justifies
          A \otimes B
        \end{prooftree}
      \]

      which holds for any additional context as long as it respects the control
      set involved in the two intermediate derivations, namely $\ctrlset{1},
      \ctrlset{2}$. Hence,
      $A_1, \dots, A_n, \Delta_1, A_{n+1}, \dots, A_{n+m},
      \Delta_2 \models_{\ctrlset{1} \cup \ctrlset{2}} A \otimes B$.

    \item Case
      $\respects{\Gamma, \Delta_1}{\ctrlset{2}} \wedge \respects{\Gamma,
        B}{\ctrlset{1}}$. Then, we can derive

      \[
        \begin{prooftree}
          \[
            \[
              A_1, \dots, A_n, \Delta_1, A_{n+1}, \dots, A_{n+m}, \Delta_2
              \leadsto
              A_1, \dots, A_n, \Delta_1, B
            \]
            \leadsto
            A, B
          \]
          \justifies
          A \otimes B
        \end{prooftree}
      \]

      As above, from this we may conclude

      \[
        A_1, \dots, A_n, \Delta_1, A_{n+1}, \dots, A_{n+m},
        \Delta_2 \vdash_{\ctrlset{1} \cup \ctrlset{2}} A \otimes B
      \]

    \item Case
      $\respects{(\Gamma, \Delta_1,
        \Delta_2)}{(\ctrlset{1}\cup\ctrlset{2})}$. Since Zsyntax allows for
      simultaneous application of inference rules, given the check condition we
      can derive

      \[
        \begin{prooftree}
          \[
            A_1, \dots, A_n, \Delta_1, A_{n+1}, \dots, A_{n+m}, \Delta_2
            \leadsto
            A, B
          \]
          \justifies
          A \otimes B
        \end{prooftree}
      \]
    \end{enumerate}

  \item The last rule is $\limp L$. Then, by inductive hypothesis, we have


    \[
      \begin{prooftree}
        A_1, \dots, A_n, \Delta_1
        \leadsto
        A
      \end{prooftree}
      \qquad \qquad
      \begin{prooftree}
        A_{n+1}, \dots, A_{n+m}, \Delta_2, B
        \leadsto
        C
      \end{prooftree}
    \]

    where $A_i \in \Gamma$ for all $i \in \{ 1, \dots, n+m\}$.
    By hypothesis the check condition is satisfied, hence
    $\respects{(\Gamma, \Delta_2, A \limp B)}{\ctrlset{1}}$ and
    $\respects{(\Gamma, \Delta_2)}{\ctrlset{A \rightarrow B}}$.
    Then, we may derive

    \[
      \begin{prooftree}
        \[
          \[
            A_1, \dots, A_n, \Delta_1, A_{n+1}, \dots, A_{n+m}, \Delta_2, A
            \rightarrow B
            \leadsto
            A_{n+1}, \dots, A_{n+m}, \Delta_2, A, A \rightarrow B
          \]
          \justifies
          A_{n+1}, \dots, A_{n+m}, \Delta_2, B
          \using{\rightarrow \mathcal{E}}
        \]
        \leadsto
        C
      \end{prooftree}
    \]

    which justifies the thesis

    \[
      A_1, \dots, A_n, \Delta_1, A_{n+1}, \dots, A_{n+m}, \Delta_2, A \rightarrow
      B \vdash_{\ctrlset{1}\cup\ctrlset{2}\cup\ctrlset{A \rightarrow B}} C
    \]

  \end{enumerate}
\end{proof}

\subsection{From natural deduction to sequent calculus}

...



We consider a very simple fragment of propositional intuitionistic
linear logic, which comprises the multiplicative connectives
$\otimes, \limp, \textbf{1}$, and the additive connective $\oplus$.

\[
  \begin{prooftree}
    \justifies
    \Gamma; P \Longrightarrow P
    \using{init}
  \end{prooftree}
  \qquad \qquad
  \begin{prooftree}
    \Gamma, A; \Delta, A \Longrightarrow C
    \justifies
    \Gamma, A; \Delta \Longrightarrow C
    \using{copy}
  \end{prooftree}
\]

\[
  \begin{prooftree}
    \Gamma; \Delta \Longrightarrow A
    \qquad
    \Gamma; \Delta' \Longrightarrow B
    \justifies
    \Gamma; \Delta, \Delta' \Longrightarrow A \otimes B
    \using{\otimes R}
  \end{prooftree}
  \qquad \qquad
  \begin{prooftree}
    \Gamma; \Delta, A, B \Longrightarrow C
    \justifies
    \Gamma; \Delta, A \otimes B \Longrightarrow C
    \using{\otimes L}
  \end{prooftree}
\]

% \[
%   \begin{prooftree}
%     \justifies
%     \Gamma; \cdot \Longrightarrow \textbf{1}
%     \using{\textbf{1} R}
%   \end{prooftree}
%   \qquad \qquad
%   \begin{prooftree}
%     \Gamma; \Delta \Longrightarrow C
%     \justifies
%     \Gamma; \Delta, \textbf{1} \Longrightarrow C
%     \using{\textbf{1} L}
%   \end{prooftree}
% \]

\[
  \begin{prooftree}
    \Gamma; \Delta \Longrightarrow A
    \qquad
    \Gamma; \Delta', B \Longrightarrow C
    \justifies
    \Gamma; \Delta, \Delta', A \limp B \Longrightarrow C
    \using{\limp L}
  \end{prooftree}
  \qquad \qquad
  \begin{prooftree}
    \Gamma; \Delta, A \Longrightarrow B
    \justifies
    \Gamma; \Delta \Longrightarrow A \limp B
    \using{\limp R}
  \end{prooftree}
\]


% \[
%   \begin{prooftree}
%     \Gamma; \Delta, A \Longrightarrow C
%     \qquad
%     \Gamma; \Delta, B \Longrightarrow C
%     \justifies
%     \Gamma; \Delta, A \oplus B \Longrightarrow C
%     \using{\oplus L}
%   \end{prooftree}
%   \qquad
%   \begin{prooftree}
%     \Gamma; \Delta \Longrightarrow A
%     \justifies
%     \Gamma; \Delta \Longrightarrow A \oplus B
%     \using{\oplus R 1}
%   \end{prooftree}
%   \qquad
%   \begin{prooftree}
%     \Gamma; \Delta \Longrightarrow B
%     \justifies
%     \Gamma; \Delta \Longrightarrow A \oplus B
%     \using{\oplus R 2}
%   \end{prooftree}
% \]

\subsection{Cut elimination}

We first show that restricting the identity axiom on atomic formulas
only is conservative:

\begin{theorem}
  The identity axiom $\Gamma; A \Longrightarrow A$, where $A$ is of
  arbitrary complexity, is admissible.
\end{theorem}
\begin{proof}
  TODO.
\end{proof}

\begin{theorem}[Linear cut elimination]
  If $\Gamma; \Delta \Longrightarrow A$ and $\Gamma; \Delta', A
  \Longrightarrow C$, then $\Gamma; \Delta, \Delta' \Longrightarrow C$.
\end{theorem}
\begin{proof}
  By nested induction on the height of the derivations of the
  premises, and the complexity of the cut formula. We can distinguish
  some cases:

  \begin{enumerate}
  \item One of the premises is an axiom. Then:

    \[
      \begin{prooftree}
        \[\justifies \Gamma; P \Longrightarrow P\] \qquad
        \[\mathcal{E}
        \leadsto
        \Gamma; P \Longrightarrow C \]
        \justifies
        \Gamma; P \Longrightarrow C
      \end{prooftree}
    \]

    then, just take $\mathcal{E}$. The second case is:

    \[
      \begin{prooftree}
        \[\mathcal{D} \leadsto \Gamma; \Delta \Longrightarrow P\]
        \qquad
        \[\justifies \Gamma; P \Longrightarrow P\]
        \justifies
        \Gamma; \Delta \Longrightarrow P
      \end{prooftree}
    \]

    then, just take $\mathcal{D}$.

  \item (Principal cuts) The cut formula is introduced by a right rule
    in the left premise, and eliminated by a left rule in the right
    premise... TODO.
  \item (Left-commutative cases) The cut formula is a side formula in
    the left premise. Then, the cut is just routinely moved to the
    premises of the last rule that has been used to derive the left
    premise, and the inductive hypothesis is applied since we act on
    derivations of strictly smaller height.

    \begin{enumerate}
    \item The last rule is $copy$:

      \[
        \begin{prooftree}
          \[
            \Gamma, A ; \Delta, A \Longrightarrow B
            \justifies
            \Gamma, A; \Delta \Longrightarrow B
            \using{copy}
          \] \qquad
          \Gamma, A; \Delta', B \Longrightarrow C
          \justifies
          \Gamma, A ; \Delta, \Delta' \Longrightarrow C
        \end{prooftree}
      \]

      Then,

      \[
        \begin{prooftree}
          \[
            \Gamma, A; \Delta, A \Longrightarrow B
            \qquad
            \Gamma, A; \Delta', B \Longrightarrow C
            \justifies
            \Gamma, A; \Delta, \Delta', A \Longrightarrow C
            \using{cut}
          \]
          \justifies
          \Gamma, A ; \Delta, \Delta' \Longrightarrow C
          \using{copy}
        \end{prooftree}
      \]


    \item The last rule was...
    \end{enumerate}

  \item (Right-commutative cases) The cut formula is a side formula in
    the right premise. Then, the cut is just routinely moved to the
    premises of the last rule that has been used to derive the right
    premise, and the inductive hypothesis is applied since we act on
    derivations of strictly smaller height.

    \begin{enumerate}
    \item The last rule is $copy$:

      \[
        \begin{prooftree}
          \Gamma, A ; \Delta \Longrightarrow C
          \qquad
          \[
            \Gamma, A; \Delta', C, A \Longrightarrow D
            \justifies
            \Gamma, A; \Delta', C \Longrightarrow D
            \using{copy}
          \]
          \justifies
          \Gamma, A; \Delta, \Delta' \Longrightarrow D
          \using{cut}
        \end{prooftree}
      \]

      then

      \[
        \begin{prooftree}
          \[
            \Gamma, A ; \Delta \Longrightarrow C
            \qquad
            \Gamma, A; \Delta', C, A \Longrightarrow D
            \justifies
            \Gamma, A; \Delta, \Delta', A \Longrightarrow D
            \using{cut}
          \]
          \justifies
          \Gamma, A; \Delta, \Delta' \Longrightarrow D
          \using{copy}
        \end{prooftree}
      \]
    \end{enumerate}
  \end{enumerate}
\end{proof}

\begin{theorem}[Persistent cut elimination]
  If $\Gamma; \cdot \Longrightarrow A$ and $\Gamma, A; \Delta
  \Longrightarrow C$, then $\Gamma; \Delta \Longrightarrow C$.
\end{theorem}
\begin{proof}
  By structural induction on the height of the derivations.
  \begin{enumerate}
  \item One of the premises is an initial sequent. Hence, the right
    premise is, and

    \[
      \begin{prooftree}
        \Gamma; \cdot \Longrightarrow A
        \qquad
        \[ \justifies \Gamma, A; P \Longrightarrow P\]
        \justifies
        \Gamma; P \Longrightarrow P
      \end{prooftree}
    \]

    but then also $\Gamma; P \Longrightarrow P$ is an identity axiom,
    and can be derived without cut.

  \item All other cases are treated as right-commutative cuts, except
    for the case where the last rule in the right premise is
    $copy$. In this case, the cut is

    \[
      \begin{prooftree}
        \Gamma; \cdot \Longrightarrow A
        \qquad
        \[
          \Gamma, A; \Delta, A \Longrightarrow C
          \justifies
          \Gamma, A ; \Delta \Longrightarrow C
          \using{copy}
        \]
        \justifies
        \Gamma; \Delta \Longrightarrow C
        \using{cut!}
      \end{prooftree}
    \]

    But then, by inductive hypothesis and admissibility of linear cut,
    we have

    \[
      \begin{prooftree}
        \Gamma; \cdot \Longrightarrow A
        \qquad
        \[
          \Gamma; \cdot \Longrightarrow A
          \qquad
          \Gamma, A; \Delta, A \Longrightarrow C
          \justifies
          \Gamma; \Delta, A \Longrightarrow C
          \using{cut!}
        \]
        \justifies
        \Gamma; \Delta \Longrightarrow C
        \using{cut}
      \end{prooftree}
    \]

  \end{enumerate}
\end{proof}

% \include{implementation}

\section{Proof terms}

\subsection{Natural deduction}

\begin{figure}[H]
  \begin{mdframed}

    \[
      \begin{prooftree}
        \justifies
        \Gamma ; \tyj{u}{A} \vdash \tyj{u}{A}
        \using{hyp}
      \end{prooftree}
      \qquad \qquad
      \begin{prooftree}
        \justifies
        \Gamma, \tyj{u}{A} ; \cdot \vdash \tyj{u}{A}
        \using{hyp!}
      \end{prooftree}
    \]

    \[
      \begin{prooftree}
        \Gamma, \Delta_1 \vdash \tyj{M}{A}
        \qquad
        \Gamma, \Delta_2 \vdash \tyj{N}{B}
        \justifies
        \Gamma, \Delta_1, \Delta_2 \vdash \tyj{\langle M, N \rangle}{A \otimes B}
        \using{\otimes I}
      \end{prooftree}
    \]

    \[
      \begin{prooftree}
        \Gamma, \Delta_1 \vdash \tyj{M}{A \otimes B}
        \qquad
        \Gamma, \Delta_2, \tyj{u}{A}, \tyj{v}{B} \vdash \tyj{N}{C}
        \justifies
        \Gamma, \Delta_1, \Delta_2 \vdash \tyj{(\textsf{let }\langle u,v \rangle = M \textsf{
            in } N)}{C}
        \using{\otimes E}
      \end{prooftree}
    \]

    \[
      \begin{prooftree}
        \Gamma ; \Delta, \tyj{u}{A} \vdash \tyj{M}{B}
        \justifies
        \Gamma ; \Delta \vdash \tyj{\lambda u . M}{A \limp B}
        \using{\limp I}
      \end{prooftree}
      \qquad
      \begin{prooftree}
        \Gamma ; \Delta \vdash \tyj{M}{A \limp B}
        \qquad
        \Gamma ; \Delta' \vdash \tyj{N}{A}
        \justifies
        \Gamma ; \Delta, \Delta' \vdash \tyj{M\ N}{B}
        \using{\limp E}
      \end{prooftree}
    \]
  \end{mdframed}
  \caption{Natural deduction calculus}
  \label{fig:dertermrules}
\end{figure}

\begin{definition}[Free variables]
  The set $FV(M)$ of free variables of a natural deduction proof term $M$ is
  inductively defined as follows:

  \begin{align*}
    FV(u) & \equiv \{ u \} \\
    FV(\langle M, N \rangle) & \equiv FV(M) \cup FV(N) \\
    FV(\textsf{let }\langle u,v \rangle = M \textsf{ in } N) & \equiv FV(M) \cup (FV(N) \setminus \{ u, v \}) \\
    FV(\lambda u . M) & \equiv FV(M) \setminus \{ u \} \\
    FV(M\ N) & \equiv FV(M) \cup FV(N)
  \end{align*}
\end{definition}

\begin{lemma}
  If $\Gamma ; \Delta \vdash \tyj{M}{A}$, then
  $FV(M) \subseteq FV(\Gamma, \Delta)$.
\end{lemma}
\begin{proof}
  Straightforward induction on the derivations.
\end{proof}

\begin{lemma}[Admissibility of weakening]
  The following rule of weakening is admissible.

  \[
    \begin{prooftree}
      \Gamma ; \Delta \vdash \tyj{M}{A}
      \justifies
      \Gamma, \tyj{u}{B} ; \Delta \vdash \tyj{M}{A}
    \end{prooftree}
  \]
\end{lemma}
\begin{proof}
  Straightforward induction on the derivations.
\end{proof}

\begin{lemma}[Admissibility of copy]
  The following copy rule is admissible.

  \[
    \begin{prooftree}
      \Gamma, \tyj{u}{A} ; \Delta, \tyj{v}{A} \vdash \tyj{M}{B}
      \justifies
      \Gamma, \tyj{u}{A} ; \Delta \vdash \tyj{M[u/v]}{B}
    \end{prooftree}
  \]
\end{lemma}
\begin{proof}
  By induction on the derivation.

  \begin{enumerate}
  \item Case $hyp$

    \[
      \begin{prooftree}
        \justifies
        \Gamma, \tyj{u}{A} ; \tyj{v}{A} \vdash \tyj{v}{A}
        \using{hyp}
      \end{prooftree}
    \]

    Then

    \[
      \begin{prooftree}
        \justifies
        \Gamma, \tyj{u}{A} ; \cdot \vdash \tyj{v[u/v] \equiv u}{A}
        \using{hyp!}
      \end{prooftree}
    \]

  \item Case $\otimes I$. Suppose $\tyj{v}{A}$ comes from the first branch (the
    other case is identical):

    \[
      \begin{prooftree}
        \Gamma, \tyj{u}{A}; \Delta_1, \tyj{v}{A} \vdash \tyj{M}{A}
        \qquad
        \Gamma, \tyj{u}{A}; \Delta_2 \vdash \tyj{N}{B}
        \justifies
        \Gamma, \tyj{u}{A} ; \Delta_1, \Delta_2, \tyj{v}{A} \vdash \tyj{\langle
          M, N \rangle}{A \otimes B}
        \using{\otimes I}
      \end{prooftree}
    \]

    By Lemma, $N$ does not contain $v$ free, hence $N[u/v] \equiv N$. Then, by
    inductive hypothesis

    \[
      \begin{prooftree}
        \Gamma, \tyj{u}{A}; \Delta_1 \vdash \tyj{M[u/v]}{A}
        \qquad
        \Gamma, \tyj{u}{A}; \Delta_2 \vdash \tyj{N[u/v]}{B}
        \justifies
        \Gamma, \tyj{u}{A} ; \Delta_1, \Delta_2 \vdash \tyj{\langle
          M[u/v], N[u/v] \rangle}{A \otimes B}
        \using{\otimes I}
      \end{prooftree}
    \]

    but $\langle M[u/v], N[u/v] \rangle \equiv \langle M,N \rangle [u/v]$.

  \item Case $\otimes E$. Suppose $\tyj{v}{A}$ comes from the second premise
    (the other case is identical).

    \[
      \begin{prooftree}
        \Gamma, \tyj{u}{A}; \Delta_1 \vdash \tyj{M}{B \otimes C}
        \qquad
        \Gamma, \tyj{u}{A}; \Delta_2,, \tyj{v}{A}, \tyj{w_1}{B}, \tyj{w_2}{C} \vdash \tyj{N}{D}
        \justifies
        \Gamma, \tyj{u}{A}; \Delta_1, \Delta_2, \tyj{v}{A} \vdash
           \tyj{(\textsf{let }\langle w_1,w_2 \rangle = M \textsf{ in } N)}{D}
        \using{\otimes E}
      \end{prooftree}
    \]

    Again, $M$ does not contain $v$ free by Lemma, hence $M[u/v] \equiv M$. But
    then, by inductive hypothesis

    \[
      \begin{prooftree}
        \Gamma, \tyj{u}{A}; \Delta_1 \vdash \tyj{M[u/v]}{B \otimes C}
        \qquad
        \Gamma, \tyj{u}{A}; \Delta_2, tyj{w_1}{B}, \tyj{w_2}{C} \vdash \tyj{N[u/v]}{D}
        \justifies
        \Gamma, \tyj{u}{A}; \Delta_1, \Delta_2, \tyj{v}{A} \vdash
           \tyj{(\textsf{let }\langle w_1,w_2 \rangle = M[u/v] \textsf{ in } N[u/v])}{D}
        \using{\otimes E}
      \end{prooftree}
    \]

    where $\textsf{let }\langle w_1,w_2 \rangle = M[u/v] \textsf{ in } N[u/v]$
    is precisely $(\textsf{let }\langle w_1,w_2 \rangle = M \textsf{ in }
    N)[u/v]$ as long as $w_1, w_2$ do not capture $u$, that is, as long as they
    are different. But they are, since they appear in the same context in the
    second premise.

  \item Case $\limp I$.

    \[
      \begin{prooftree}
        \Gamma, \tyj{u}{A} ; \Delta, \tyj{v}{A}, \tyj{w}{B} \vdash \tyj{M}{C}
        \justifies
        \Gamma, \tyj{u}{A} ; \Delta, \tyj{v}{A} \vdash \tyj{\lambda w . M}{B \limp C}
        \using{\limp I}
      \end{prooftree}
    \]

    Then, by inductive hypothesis

    \[
      \begin{prooftree}
        \Gamma, \tyj{u}{A} ; \Delta, \tyj{w}{B} \vdash \tyj{M[u/v]}{C}
        \justifies
        \Gamma, \tyj{u}{A} ; \Delta \vdash \tyj{\lambda w . M[u/v]}{B \limp C}
        \using{\limp I}
      \end{prooftree}
    \]

    where $\lambda w . M[u/v] \equiv (\lambda w . M)[u/v]$ as long as $w \not
    \equiv u$, which is true since tey appear in the same context.

  \item Case $\limp E$ is identical to $\otimes I$.
  \end{enumerate}
\end{proof}

Before giving the translation from labelled forward sequent derivation to
natural deduction proof terms, we define some auxiliary functions.


\begin{align*}
  \textsf{common}([] ; \Gamma') & = [] \\
  \textsf{common}(\tyj{x}{A}, \Gamma ; \Gamma')
                                & =
                                  \begin{cases}
                                    (w, x, y, A), \textsf{common}(\Gamma ;
                                    \Gamma')\; (w \text{ fresh}), & \text{if } \tyj{y}{A} \in
                                    \Gamma' \\
                                    \textsf{common}(\Gamma ; \Gamma'), & \text{otherwise}
                                  \end{cases}
\end{align*}

If $C = \textsf{common}(\Gamma ; \Gamma')$, then


% \[
%   C_0 = \{ \tyj{w}{A} \, | \, (w, \_, \_, A) \in C \}
% \]
\[
  C_1 = \{ \tyj{x}{A} \, | \, (\_, x, \_, A) \in C \}
\]
\[
  C_2 = \{ \tyj{y}{A} \, | \, (\_, \_, y, A) \in C \}
\]

A common set $C$ is applied to a deduction $\Gamma ; \Delta \vdash \tyj{M}{A}$
as follows:

\[
  \begin{prooftree}
    \Gamma ; \Delta \vdash \tyj{M}{A}
    \qquad []
    \justifies
    \Gamma ; \Delta \vdash \tyj{M}{A}
    \using{apply _{1/2}}
  \end{prooftree}
\]

\[
  \begin{prooftree}
    \[
      \Gamma ; \Delta \vdash \tyj{M}{A}
      \qquad
      (w, x, y, A), C
      \justifies
      \Gamma[w/x] ; \Delta \vdash \tyj{M[w/x]}{A}
      \using{apply _1}
    \]
    C
    \justifies
    \Gamma ; \Delta \vdash \tyj{M}{A}
    \using{apply _1}
  \end{prooftree}
  \qquad
  \begin{prooftree}
    \[
      \Gamma ; \Delta \vdash \tyj{M}{A}
      \qquad
      (w, x, y, A), C
      \justifies
      \Gamma[w/y] ; \Delta \vdash \tyj{M[w/y]}{A}
      \using{apply _2}
    \]
    C
    \justifies
    \Gamma ; \Delta \vdash \tyj{M}{A}
    \using{apply _2}
  \end{prooftree}
\]

\begin{lemma}
  The following substitution rule is admissible:

  \[
    \begin{prooftree}
      \Gamma ; \Delta_1 \vdash \tyj{M}{A}
      \qquad
      \Gamma ; \Delta_2, \tyj{u}{A} \vdash \tyj{N}{B}
      \justifies
      \Gamma ; \Delta_1, \Delta_2 \vdash \tyj{N[M/u]}{B}
    \end{prooftree}
  \]
\end{lemma}
\begin{proof}
  TODO.
\end{proof}

\begin{theorem}
  Given a labelled forward derivation
  $\seqpt{\mathcal{D}}{\fwdseq{\Gamma}{\Delta}{C}}$ in which every formula
  appears at most once in $\Gamma$, there exists a natural deduction derivation
  $\Gamma ; \Delta \vdash \tyj{M}{C}$ for some $M$.
\end{theorem}
\begin{proof}
  \begin{enumerate}
  \item Case $\init$

    \[
      \begin{prooftree}
        \justifies
        \seqpt{\dtinit{p}}{\fwdseq{\cdot}{\labels{p}{p}}{p}}
      \end{prooftree}
    \]

    Then

    \[
      \begin{prooftree}
        \justifies
        \cdot ; \tyj{u}{p} \vdash \tyj{u}{p}
        \using{hyp}
      \end{prooftree}
    \]

    where $u$ is a fresh variable.

  \item Case $\copyrule$.

    \[
      \begin{prooftree}
        \seqpt{\mathcal{D}}{
          \fwdseq{\Gamma}{\Delta, \labels{l^{k+1}}{A}}{C}}
        \justifies
        \seqpt{\dtcopy{\mathcal{D}}{l}{A}}{
          \fwdseq{\Gamma \cup \labels{l}{A}}{\Delta, \labels{l^k}{A}}{C}}
      \end{prooftree}
    \]

    By inductive hypothesis, we have
    $\Gamma_n ; \Delta_n, \tyj{v}{A} \vdash \tyj{M}{C}$. Suppose $\Gamma$ does
    not contain labels for $A$, so that $\Gamma_n$ does
    not contain an hypothesis relative to $A$. Then, by weakening and copy:

    \[
      \begin{prooftree}
        \[
          \Gamma_n ; \Delta_n, \tyj{v}{A} \vdash \tyj{M}{C}
          \justifies
          \Gamma_n, \tyj{u}{A} ; \Delta_n, \tyj{v}{A} \vdash \tyj{M}{C}
        \]
        \justifies
        \Gamma_n, \tyj{u}{A} ; \Delta_n \vdash \tyj{M[u/v]}{C}
      \end{prooftree}
    \]

    If $\Gamma$ does contain $A$ then the thesis follows in the same way just by
    a direct application of the copy rule.

  \item Case $\otimes R$.

    \[
      \begin{prooftree}
        \seqpt{\mathcal{D}}{\fwdseq{\Gamma}{\Delta}{A}}
        \quad
        \seqpt{\mathcal{D'}}{\fwdseq{\Gamma'}{\Delta'}{B}}
        \justifies
        \seqpt{
          \dtotimesr{\mathcal{D}}{\mathcal{D'}}{r}{A \otimes B}
        }{
          \fwdseq{\Gamma \cup \Gamma'}{\Delta, \Delta'}{A \otimes B}
        }
      \end{prooftree}
    \]

    By inductive hypothesis, we have

    \[
      \begin{array}{@{}c}
        \Gamma_n ; \Delta_n \vdash \tyj{M}{A} \\
        \Gamma'_n ; \Delta'_n \vdash \tyj{N}{B}
      \end{array}
    \]

    Let $C = \textsf{common}(\Gamma_n ; \Gamma'_n)$. Then, we have

    \[
      \begin{prooftree}
        \[
          \[
            \Gamma_n ; \Delta_n \vdash \tyj{M}{A}
            \justifies
            \Gamma_n, \Gamma'_n \setminus C_2 ; \Delta_n \vdash \tyj{M}{A}
            \using{weak}
          \]
          \qquad
          C
          \justifies
          \Gamma''_n ; \Delta_n \vdash \tyj{M'}{A}
          \using{apply_1}
        \]
        \[
          \[
            \Gamma'_n ; \Delta'_n \vdash \tyj{N}{B}
            \justifies
            \Gamma'_n, \Gamma_n \setminus C_1 ; \Delta'_n \vdash \tyj{N}{B}
          \]
          \qquad
          C
          \justifies
          \Gamma_n'' ; \Delta'_n \vdash \tyj{N'}{B}
        \]
        \justifies
        \Gamma''_n ; \Delta_n, \Delta'_n \vdash \tyj{\langle M',N' \rangle}{A
          \otimes B}
      \end{prooftree}
    \]

  \item Case $\otimes L$


    \[
      \begin{prooftree}
        \seqpt{
          \mathcal{D}
        }{
          \fwdseq{\Gamma}{\Delta, \labels{l_1^{k_1 + 1}}{A}, \labels{l_2^{k_2 +
                1}}{B}, \labels{l^k}{A \otimes B}}{C}
        }
        \justifies
        \seqpt{
          \dtotimesl{\mathcal{D}}{l_1}{A}{l_2}{B}{l}{A \otimes B}
        }{
          \fwdseq{\Gamma}{\Delta, l_1^{k_1}, l_2^{k_2}, l^{k+1}}{C}
        }
      \end{prooftree}
    \]

    By inductive hypothesis, we have $\Gamma_n ; \Delta_n, \tyj{u}{A},
    \tyj{v}{B} \vdash \tyj{N}{C}$. Then

    \[
      \begin{prooftree}
        \[
          \justifies
          \Gamma_n ; \tyj{w}{A \otimes B} \vdash \tyj{w}{A \otimes B}
          \using{hyp}
        \]
        \qquad
        \Gamma_n ; \Delta_n, \tyj{u}{A}, \tyj{v}{B} \vdash \tyj{N}{C}
        \justifies
        \Gamma_n ; \Delta_n, \tyj{w}{A \otimes B} \vdash \tyj{(\textsf{let
          }\langle u,v \rangle = w \textsf{ in } N)}{C}
        \using{\otimes E}
      \end{prooftree}
    \]

  \item Case $\limp R$.


    \[
      \begin{prooftree}
        \seqpt{\mathcal{D}}{\fwdseq{\Gamma}{\Delta, \labels{l^{k+1}}{A}}{B}}
        \justifies
        \seqpt{
          \dtlimpr{\mathcal{D}}{l}{A}{r}{A \limp B}
        }{
          \fwdseq{\Gamma}{\Delta, \labels{l^k}{A}}{\labels{r}{A \limp B}}
        }
      \end{prooftree}
    \]

    By inductive hypothesis, we have
    $\Gamma_n ; \Delta_n, \tyj{u}{A} \vdash \tyj{M}{B}$. Then,

    \[
      \begin{prooftree}
        \Gamma_n ; \Delta_n, \tyj{u}{A} \vdash \tyj{M}{B}
        \justifies
        \Gamma_n ; \Delta_n \vdash \tyj{\lambda u . M}{A \limp B}
        \using{\limp I}
      \end{prooftree}
    \]

  \item Case $\limp L$.

    \[
      \begin{prooftree}
        \seqpt{\mathcal{D}}{\fwdseq{\Gamma}{\Delta}{\labels{r}{A}}}
        \quad
        \seqpt{\mathcal{D'}}{\fwdseq{\Gamma'}{\Delta', \labels{l^{k_l+1}}{B}, \labels{s^{k_s}}{A
              \limp B}}{C}}
        \justifies
        \seqpt{
          \dtlimpl{\mathcal{D}}{\mathcal{D'}}{l}{B}{s}{A \limp B}
        }{
          \fwdseq{\Gamma \cup \Gamma'}{\Delta, \Delta',
            \labels{l^{k_l}}{B}, \labels{s^{k_s + 1}}{A \limp B}}{C}
        }
      \end{prooftree}
    \]

    By inductive hypothesis, we have

    \[
      \begin{array}{@{}c}
        \Gamma_n ; \Delta_n \vdash \tyj{M}{A} \\
        \Gamma'_n ; \Delta'_n, \tyj{u}{B} \vdash \tyj{N}{C}
      \end{array}
    \]

    therefore

    \[
      \begin{prooftree}
        \[
          \[
            \[
              \[
                \justifies
                \Gamma_n ; \tyj{w}{A \limp B} \vdash \tyj{w}{A \limp B}
              \]
              \qquad
              \Gamma_n ; \Delta_n \vdash \tyj{M}{A}
              \justifies
              \Gamma_n ; \Delta_n, \tyj{w}{A \limp B} \vdash \tyj{w M}{B}
            \]
            \justifies
            \Gamma_n, \Gamma'_n \setminus C_2 ; \Delta_n, \tyj{w}{A \limp B}
            \vdash\tyj{w M}{B}
            \using{weak}
          \]
          \qquad
          C
          \justifies
          \Gamma''_n ; \Delta_n, \tyj{w}{A \limp B} \vdash \tyj{w M}{B}
        \]
        \qquad
        \[
          \[
            \Gamma'_n ; \Delta'_n, \tyj{u}{B} \vdash \tyj{N}{C}
            \justifies
            \Gamma'_n, \Gamma_n \setminus C_1 ; \Delta'_n, \tyj{u}{B} \vdash \tyj{N}{C}
          \]
          \qquad
          C
          \justifies
          \Gamma''_n ; \Delta'_n, \tyj{u}{B} \vdash \tyj{N}{C}
        \]
        \justifies
        \Gamma''_n ; \Delta_n, \Delta'_n, \tyj{w}{A \limp B} \vdash
        \tyj{N[w M / u]}{C}
        \using{sost}
      \end{prooftree}
    \]
  \end{enumerate}
\end{proof}

Notice that the constructive proof of the theorem above automatically gives a
method to translate every labelled forward calculus derivation into a natural
deduction derivation.

\subsection{Derivation terms for forward labelled sequent calculus}

\[
  \begin{prooftree}
    \justifies
    \seqpt{\dtinit{p}}{\fwdseq{\cdot}{\labels{p}{p}}{p}}
  \end{prooftree}
\]

\[
  \begin{prooftree}
    \seqpt{\mathcal{D}}{
      \fwdseq{\Gamma}{\Delta, \labels{l^{k+1}}{A}}{C}}
    \justifies
    \seqpt{\dtcopy{\mathcal{D}}{l}{A}}{
      \fwdseq{\Gamma \cup \labels{l}{A}}{\Delta, \labels{l^k}{A}}{C}}
  \end{prooftree}
\]

\[
  \begin{prooftree}
    \seqpt{\mathcal{D}}{\fwdseq{\Gamma}{\Delta}{A}}
    \quad
    \seqpt{\mathcal{D'}}{\fwdseq{\Gamma'}{\Delta'}{B}}
    \justifies
    \seqpt{
      \dtotimesr{\mathcal{D}}{\mathcal{D'}}{r}{A \otimes B}
    }{
      \fwdseq{\Gamma \cup \Gamma'}{\Delta, \Delta'}{A \otimes B}
    }
  \end{prooftree}
\]

\[
  \begin{prooftree}
    \seqpt{
      \mathcal{D}
    }{
      \fwdseq{\Gamma}{\Delta, \labels{l_1^{k_1 + 1}}{A}, \labels{l_2^{k_2 +
            1}}{B}, \labels{l^k}{A \otimes B}}{C}
    }
    \justifies
    \seqpt{
      \dtotimesl{\mathcal{D}}{l_1}{A}{l_2}{B}{l}{A \otimes B}
    }{
      \fwdseq{\Gamma}{\Delta, l_1^{k_1}, l_2^{k_2}, l^{k+1}}{C}
    }
  \end{prooftree}
\]

\[
  \begin{prooftree}
    \seqpt{\mathcal{D}}{\fwdseq{\Gamma}{\Delta, \labels{l^{k+1}}{A}}{B}}
    \justifies
    \seqpt{
      \dtlimpr{\mathcal{D}}{l}{A}{r}{A \limp B}
    }{
      \fwdseq{\Gamma}{\Delta, \labels{l^k}{A}}{\labels{r}{A \limp B}}
    }
  \end{prooftree}
\]

\[
  \begin{prooftree}
    \seqpt{\mathcal{D}}{\fwdseq{\Gamma}{\Delta}{\labels{r}{A}}}
    \quad
    \seqpt{\mathcal{D'}}{\fwdseq{\Gamma'}{\Delta', \labels{l^{k_l+1}}{B}, \labels{s^{k_s}}{A
          \limp B}}{C}}
    \justifies
    \seqpt{
      \dtlimpl{\mathcal{D}}{\mathcal{D'}}{l}{B}{s}{A \limp B}
    }{
      \fwdseq{\Gamma \cup \Gamma'}{\Delta, \Delta',
        \labels{l^{k_l}}{B}, \labels{s^{k_s + 1}}{A \limp B}}{C}
    }
  \end{prooftree}
\]

\subsection{Derivation terms assignement for rule calculus}

The relations can be extended to relate not only premise sequents to conclusion
sequents, but also derivation terms of those premises to the corresponding
derivation term of the conclusion. The extension regarding derivation terms in
shown in Figure~\ref{fig:dertermrules}. We therefore consider relations of the
form $\relj{\frfrel{C}}{\seqpt{\mathcal{D}_1}{s_1} \cdots
  \seqpt{\mathcal{D}_n}{s_n}}{\seqpt{\mathcal{D}}{s}}$.

\begin{figure}[h]
  \begin{mdframed}
    \[
      \begin{prooftree}
        p \; \text{left-biased}
        \justifies
        \relj{\frfrel{p}}{\cdot}{\dtinit{p}}
        \using{\linit}
      \end{prooftree}
      \qquad\qquad
      \begin{prooftree}
        p \; \text{right-based}
        \justifies
        \relj{\flfrel{p}}{\cdot}{\dtinit{p}}
        \using{\rinit}
      \end{prooftree}
    \]

    \[
      \begin{prooftree}
        \relj{\factrel{\btriseq{\cdot}{\cdot}{\cdot}{R}}}{\Sigma}{\mathcal{D}}
        \justifies
        \relj{\frfrel{R}}{\Sigma}{\mathcal{D}}
        \using{\faplus}
      \end{prooftree}
      \qquad \qquad
      \begin{prooftree}
        \relj{\factrel{\btriseq{\cdot}{\cdot}{L}{\cdot}}}{\Sigma}{\mathcal{D}}
        \justifies
        \relj{\flfrel{L}}{\Sigma}{\mathcal{D}}
        \using{\faminus}
      \end{prooftree}
    \]

    \[
      \begin{prooftree}
        p \text{ right-biased}
        \justifies
        \frfrelj{p}{\seqpt{\mathcal{D}}{s}}{\mathcal{D}}
        \using{conj^+}
      \end{prooftree}
    \]

    \[
      \begin{prooftree}
        p \text{ left-biased}
        \justifies
        \flfrelj{p}{\seqpt{\mathcal{D}}{s}}{\mathcal{D}}
        \using{conj^-}
      \end{prooftree}
    \]

    \[
      \begin{prooftree}
        \relj{\frfrel{A}}{\Sigma_2}{\mathcal{D}}
        \qquad
        \relj{\flfrel{\labels{l}{B}}}{\Sigma_1}{\mathcal{D'}}
        \justifies
        \relj{\flfrel{\labels{r}{A \limp B}}}{\Sigma_1 \cdot \Sigma_2}{
          \dtlimpl{\mathcal{D}}{\mathcal{D'}}{l}{B}{r}{A \limp B}
        }
        \using{\limp F}
      \end{prooftree}
    \]

    \[
      \begin{prooftree}
        \relj{\frfrel{A}}{\Sigma_1}{\mathcal{D}}
        \qquad
        \relj{\frfrel{B}}{\Sigma_2}{\mathcal{D'}}
        \justifies
        \relj{\frfrel{\labels{r}{A \otimes B}}}{\Sigma_1 \cdot \Sigma_2}{
          \dtotimesr{\mathcal{D}}{\mathcal{D'}}{r}{A \otimes B}
        }
        \using{\otimes F}
      \end{prooftree}
    \]

    \[
      \begin{prooftree}
        \relj{\factrel{\btriseq{\Gamma}{\Delta}{\Omega \cdot \labels{l}{A}}{B}}}{\Sigma}{\mathcal{D}}
        \justifies
        \relj{\factrel{\btriseq{\Gamma}{\Delta}{\Omega}{\labels{r}{A \limp
                B}}}}{\Sigma}{
          \dtlimpr{\mathcal{D}}{l}{A}{r}{A \limp B}
        }
        \using{\limp A}
      \end{prooftree}
    \]

    \[
      \begin{prooftree}
        \relj{\factrel{
            \btriseq{\Gamma}{\Delta}{\Omega \cdot \labels{l_A}{A} \cdot \labels{l_B}{B}}{\xi}}
        }{\Sigma}{\mathcal{D}}
        \justifies
        \relj{\factrel{
            \btriseq{\Gamma}{\Delta}{\Omega \cdot \labels{l}{A \otimes B}}{\xi}}
        }{\Sigma}{
          \dtotimesl{\mathcal{D}}{l_A}{A}{l_B}{B}{l}{A \otimes B}
        }
        \using{\otimes A}
      \end{prooftree}
    \]

    \[
      \begin{prooftree}
        \relj{\factrel{\btriseq{\Gamma}{\Delta, P}{\Omega}{\xi}}}{\Sigma}{\mathcal{D}}
        \justifies
        \relj{\factrel{\btriseq{\Gamma}{\Delta}{\Omega \cdot P}{\xi}}}{\Sigma}{\mathcal{D}}
        \using{\actrule}
      \end{prooftree}
    \]

    \[
      \begin{prooftree}
        \xi \subseteq \gamma
        \justifies
        \relj{
          \factrel{\btriseq{\Gamma}{\Delta}{\cdot}{\xi}}
        }{
          \seqpt{\mathcal{D}}{\fneuseq{\Gamma, \Gamma'}{\Delta, \Delta'}{\gamma}}
        }{
          \mathcal{D}
        }
        \using{\matchrule}
      \end{prooftree}
    \]
  \end{mdframed}
  \caption{Derivation term assignment for forward rule calculus}
  \label{fig:dertermrules}
\end{figure}

The derived rule for positive subformulas is:

\[
  \begin{prooftree}
    s_1 \quad \dots \quad s_n \quad
    (\relj{\frfrel{Q}}{s_1 \dots s_n}{
      \seqpt{\mathcal{D}}{\fneuseq{\Gamma}{\Delta}{\cdot}}
    })
    \justifies
    \seqpt{\mathcal{D}}{\fneuseq{\Gamma}{\Delta}{Q}}
    \using{\focplusrule}
  \end{prooftree}
\]

Similarly, for negative propositions, we have two rules:

\[
  \begin{prooftree}
    s_1 \quad \dots \quad s_n \quad
    (\relj{\flfrel{P}}{s_1 \dots s_n}{
      \seqpt{\mathcal{D}}{\fneuseq{\Gamma}{\Delta}{Q}}
    })
    \justifies
    \seqpt{\mathcal{D}}{\fneuseq{\Gamma}{\Delta, P}{Q}}
    \using{\focminusrule}
  \end{prooftree}
\]

\[
  \begin{prooftree}
    s_1 \quad \dots \quad s_n \quad
    (\relj{\flfrel{\labels{l}{A}}}{s_1 \dots s_n}{
      \seqpt{\mathcal{D}}{\fneuseq{\Gamma}{\Delta}{Q}}
    })
    \justifies
    \seqpt{\dtcopy{\mathcal{D}}{l}{A}}{\fneuseq{\Gamma, A}{\Delta}{Q}}
    \using{\foccopyrule}
  \end{prooftree}
\]

\end{document}

%%% Local Variables:
%%% mode: latex
%%% TeX-master: t
%%% End:
